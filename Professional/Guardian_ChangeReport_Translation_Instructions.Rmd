---
title: "Guardian_ChangeReport_Translation_Instructions.Rmd"
author: "Paul M Washburn"
date: "July 10, 2015"
output: html_document
---
## Guardian Change Report Processing Instructions

Export the file as a CSV file, NOT an Excel file. 

Before starting this process, make sure to sort the exported file by the Employee.SSN, Relationship.Status..No.Codes.(which will be a custom sort by Employee, Spouse and Child), then by First.Name.
```{r}
print("Ensure that file has been custom sorted by the Guardian Sort macro in Excel.")
```

### File Pre-Processing 

To reiterate, prior to running this script do the custom sort described above. 

First, you must tell R where the exported file lives. It is a good idea to save the file in the following fasihon: "mmddyyyy_Guardian_CompanName_Export.csv". 

Save it to the file folder of your choice. It will be different from the one below, so make sure that you EDIT the path so R knows where to access the file. 

File path is below:

```{r}
setwd("C:/Users/pwashburn/Desktop/Input")
```

The code below will read in the file.
```{r}
print("Reading in the File.") 
Guardian<-read.csv("07142015_Guardian_Suntrup_Export.csv",
                   header=TRUE,stringsAsFactors=FALSE,na.strings="NA")
```

The code below will make all characters in the Guardian object upper case.
```{r}
print("Converting to Upper Case.")
Guardian<-data.frame(lapply(Guardian, function(v) {
    if (is.character(v)) return(toupper(v))
    else return (v)
}))
```

Remove dashes from SSN and Phone Numbers.
```{r}
print("Removing dashes from SSN and phone numbers.")
Guardian$Employee.SSN<-gsub("-","",Guardian$Employee.SSN)
Guardian$Work.Phone<-gsub("-","",Guardian$Work.Phone)
Guardian$Home.Phone<-gsub("-","",Guardian$Home.Phone)
```

Later in the script we will need a FILLER column that will be a mechanism for creating blank columns in the spreadsheet. The code below will create a filler column.
```{r}
print("Creating filler columns.")
col<-Guardian$Hourly.Rate
for(i in col)
    Guardian$FILLER<- NA
    Guardian$FILLER<-ifelse(is.na(Guardian$FILLER)," "," ")
```
    

The code below will add gender to Relationship, per Guardian specifications.
```{r}
print("Adding gender to relationship column, coding to Guardian standards.")
Guardian$Relationship..No.Codes.<-ifelse(Guardian$Relationship..No.Codes.=="EMPLOYEE","M",
                                         ifelse(Guardian$Relationship..No.Codes.=="SPOUSE" & Guardian$Gender == "M","H",
                                                ifelse(Guardian$Relationship..No.Codes.=="SPOUSE" & Guardian$Gender == "F","W",
                                                       ifelse(Guardian$Relationship..No.Codes.=="CHILD" & Guardian$Gender == "M","S","D"))))
```

Guardian does not want periods or dashes in Address or City. The code below will replace periods and dashes in Address and City.
```{r}
print("Replacing periods and dashes in Address and City.")
Guardian$Home.Address.1<-gsub("\\.|/|\\-","",Guardian$Home.Address.1)
Guardian$City<-gsub("\\.|/|\\-","",Guardian$City)
```

Hours per week contains NA values. This code removes NA's.
```{r}
print("Rid NAs from Hours per Week.")
Guardian$Hours.Per.Week<-ifelse(!is.na(Guardian$Hours.Per.Week),Guardian$Hours.Per.Week,"")
```

Below will transform Reason.for.Change column into Guardian codes:

1. LA=Leave of Absence, MD=Member Death, 
2. TE=Terminated, 
3. AD=Adoption, 
4. BR=Birth, 
5. MR=Marriage, 
6. DI=Divorce, 
7. OT=Other, 
8. CB=Cobra, 
9. ST=State
```{r}
print("Coding reason per Guardian specs. Saving Reason for Change long version for downstream code.")
reasons<-as.character(Guardian$Reason.for.Change)
Guardian$Reason.for.Change<-ifelse(Guardian$Reason.for.Change=="TERMINATION","TE",
                                   ifelse(Guardian$Reason.for.Change=="BIRTH","BR",
                                          ifelse(Guardian$Reason.for.Change=="MARRIAGE","MR",
                                                 ifelse(Guardian$Reason.for.Change=="DIVORCE","DI",
                                                        ifelse(grepl("COBRA",Guardian$Reason.for.Change),"CO","OT")))))
```

There are quite a few columns that Guardian wants that are not in the SBM export. Below those columns are created. 

Most of them will be "Y" or "N" to indicate whether a type of policy was selected. Otherwise, there will be coverage amounts, effective dates, descriptions, and a couple others. 
```{r}
print("Adding columns to match Guardian spreadsheet.")
dat<-Guardian$Coverage.Effective.Date
dat<-as.character(dat)
type<-Guardian$Benefit.Plan.Type
amt<-as.character(Guardian$Coverage.Amount.1)
desc<-as.character(Guardian$Group.Suffix.4)

Guardian$Dental.Elected<-ifelse(type=="DENTAL","Y","N")
Guardian$Dental.Eff.Date<-ifelse(Guardian$Dental.Elected=="Y",dat," ")
Guardian$Dental.Description<-ifelse(Guardian$Dental.Elected=="Y",desc," ")

Guardian$Basic.Employee.Life.Elected<-ifelse(type=="BASIC EMPLOYEE LIFE" | type=="ACCIDENT TIER BASED","Y","N")
Guardian$Basic.Life.Eff.Date<-ifelse(Guardian$Basic.Employee.Life.Elected=="Y",dat," ")
Guardian$Basic.Life.Coverage.Amount<-ifelse(Guardian$Basic.Employee.Life.Elected=="Y",amt," ")
Guardian$Basic.Life.Description<-ifelse(Guardian$Basic.Employee.Life.Elected=="Y",desc," ")

Guardian$Voluntary.Employee.Life.Elected<-ifelse(type=="VOLUNTARY EMPLOYEE LIFE" | type=="VOLUNTARY SPOUSAL LIFE (INDIVIDUAL)","Y","N")
Guardian$Voluntary.Employee.Life.Eff.Date<-ifelse(Guardian$Voluntary.Employee.Life.Elected=="Y",dat," ")
Guardian$Voluntary.Employee.Life.Coverage.Amount<-ifelse(Guardian$Voluntary.Employee.Life.Elected=="Y",amt," ")


Guardian$Voluntary.Spousal.Life.Elected<-ifelse(type=="VOLUNTARY SPOUSAL LIFE","Y","N")
Guardian$Voluntary.Spousal.Life.Eff.Date<-ifelse(Guardian$Voluntary.Spousal.Life.Elected=="Y",dat," ")
Guardian$Voluntary.Spousal.Life.Coverage.Amount<-ifelse(Guardian$Voluntary.Spousal.Life.Elected=="Y",amt," ")

Guardian$Voluntary.Child.Life.Elected<-ifelse(type=="VOLUNTARY CHILD LIFE","Y","N")
Guardian$Vol.Child.Life.Eff.Date<-ifelse(Guardian$Voluntary.Child.Life.Elected=="Y",dat," ")
Guardian$Voluntary.Child.Life.Coverage.Amount<-ifelse(Guardian$Voluntary.Child.Life.Elected=="Y",amt," ")

Guardian$Vision.Elected<-ifelse(type=="VISION","Y","N")
Guardian$Vision.Eff.Date<-ifelse(Guardian$Vision.Elected=="Y",dat," ")
Guardian$Vision.Description<-ifelse(Guardian$Vision.Elected=="Y",desc," ")

Guardian$Cancer.Elected<-ifelse(type=="CANCER","Y","N")
Guardian$Cancer.Eff.Date<-ifelse(Guardian$Cancer.Elected=="Y",dat," ")
Guardian$Cancer.Descriptor<-ifelse(Guardian$Cancer.Elected =="Y",desc," ")

Guardian$STD.Elected<-ifelse(type=="SHORT TERM DISABILITY","Y","N")
Guardian$STD.Eff.Date<-ifelse(Guardian$STD.Elected=="Y",dat," ")
Guardian$STD.Coverage.Amount<-ifelse(Guardian$STD.Elected =="Y",amt," ")
```

Guardian wants to combine spouse and child elections for dependent life. The code below will combine spouse and child voluntary selections.
```{r}
spouse<-Guardian$Voluntary.Spousal.Life.Elected
kid<-Guardian$Voluntary.Child.Life.Elected
Guardian$Dep.Life.Selected<-ifelse(spouse == "Y" | kid == "Y", "Y", "N")
# Combine Dependent and Spouse effective dates using an or statement
Guardian$Dep.Life.Eff.Date<-ifelse(spouse == "Y" | kid == "Y",dat," ")
```

Change Time.Status..No.Codes. column A=Active, T=Terminated, R=Retired. 
```{r}
print("Swapping codes for Time Status per Guardian's specs.")
Guardian$Time.Status..No.Codes.<-ifelse(Guardian$Time.Status..No.Codes.=="FULL TIME SALARY","A",
                                        ifelse(Guardian$Time.Status..No.Codes.=="PART TIME","A",
                                               ifelse(Guardian$Time.Status..No.Codes.=="TERMINATED","T","R")))
```

Below still needs to be coded; it has not been successfully completed.
```{r}
print("Change Tobacco.User.Code {M, W, H, D, S} to {M, S, B, N} member spouse both neither")
print("Below is dead code.")
#####rel<-Guardian$Relationship..No.Codes.
#####ifelse(rel=="M" & Guardian$Tobacco.User..No.Codes.=="Y",)
```

Guardian wants to know if and when Cobra was elected. The code below will populate "Cobra enrollment date" as a new column. It will also add a "Y" or "N" if it is elected. 
```{r}
ben<-as.character(Guardian$Benefit.Class.Date)
Cobra.Enrollment.Date<-ifelse(Guardian$Reason.for.Change=="CO",ben," ")
Guardian<-cbind(Guardian,Cobra.Enrollment.Date)
# Put Y or N in Coverage Extension column
Guardian$Coverage.Extension<-ifelse(Guardian$Reason.for.Change=="CO","Y","N")
```

Replace the contents of Hire.Date column with Re.Hire.Date if a Re.Hire.Date exists, if not then keep as is.
```{r}
print("Replace hire date with rehire date if it exists. Print of rehire date to be sure.")
dat<-as.character(Guardian$Hire.Date)
redat<-as.character(Guardian$Re.Hire.Date)
redat
Guardian$Hire.Date<-ifelse(is.na(redat),dat,redat)
```

### Rearrange and Filter out Unncessary column
```{r}
print("Creating a new data frame filtering out and arranging columns.")
# Create new data frame from Guardian object
# Drop all columns that are not necessary 
print("Dropping unnecessary columns and saving to new data frame.")
GuardianDf<-data.frame(Guardian)
keeps<-names(GuardianDf) %in% c("Employee.SSN","Last.Name","First.Name","Middle.Initial","Relationship..No.Codes.",
                       "Date.of.Birth","Gender","Marital.Status","FILLER","Home.Address.1","City","State",
                       "Zip","Work.Email","Work.Phone","Hire.Date","Hours.Per.Week",
                       "Employment.Status..No.Codes.",
                       "Coverage.Termination.Date","Reason.for.Change","Salary",
                       "Location","Tobacco.User..No.Codes.",
                       "Dental.Elected","Dental.Eff.Date","Vision.Elected","Vision.Eff.Date",
                       "Basic.Employee.Life.Elected","Basic.Life.Eff.Date","Voluntary.Child.Life.Elected",
                       "Vol.Child.Life.Eff.Date","Benefit.Plan.Type",
                       "Coverage.Effective.Date","Benefit.Class.Name",
                       "Cancer.Elected","Cancer.Eff.Date","Voluntary.Spousal.Life.Elected",
                       "Voluntary.Spousal.Life.Eff.Date","Voluntary.Spousal.Life.Coverage.Amount",
                       "Voluntary.Employee.Life.Elected","Voluntary.Employee.Life.Eff.Date",
                       "Voluntary.Employee.Life.Coverage.Amount","Voluntary.Spousal.Life.Coverage.Amount",
                       "Voluntary.Child.Life.Coverage.Amount","Basic.Life.Coverage.Amount",
                       "Benefit.Class.SubCode1",
                       "Group.Suffix.4","Dental.Description","Benefit.Class.SubCode1","Benefit.Class.Code",
                       "Vision.Description","Basic.Life.Description","Dep.Life.Selected",
                       "Dep.Life.Eff.Date","Cancer.Descriptor","Cobra.Enrollment.Date",
                       "STD.Elected","STD.Eff.Date","STD.Coverage.Amount","Coverage.Extension")      ##ARE THERE ANYMORE WE NEED TO KEEP?
GuardianDf<-GuardianDf[keeps]
```

Put columns in same order as the Guardian spreadsheet.
```{r}
print("Ordering the columns per Guardian's specifications")
orderColumns <- c("Employee.SSN","Last.Name","First.Name","Middle.Initial",
                  "Relationship..No.Codes.",
                  "Date.of.Birth","Gender","Marital.Status","FILLER","FILLER",
                  "Home.Address.1","City","State",
                  "Zip","Work.Email","Work.Phone","Hire.Date",
                  "Hours.Per.Week","Employment.Status..No.Codes.",
                  "Coverage.Termination.Date","Reason.for.Change","Coverage.Extension","Salary",
                  "FILLER","Benefit.Class.Code","Location",
                  "Tobacco.User..No.Codes.",
                  "FILLER","FILLER","FILLER","FILLER","FILLER",
                  "Dental.Elected","Dental.Eff.Date","Dental.Description",
                  "FILLER","FILLER","Vision.Elected","Vision.Eff.Date","Vision.Description",
                  "FILLER","Basic.Employee.Life.Elected","Basic.Life.Description",
                  "Basic.Life.Coverage.Amount","Basic.Life.Eff.Date","FILLER","FILLER",
                  "Voluntary.Employee.Life.Elected","Voluntary.Employee.Life.Coverage.Amount",
                  "Voluntary.Employee.Life.Eff.Date","FILLER","Dep.Life.Selected","FILLER",
                  "Voluntary.Spousal.Life.Coverage.Amount","Voluntary.Child.Life.Coverage.Amount",
                  "FILLER","Dep.Life.Eff.Date",
                  "FILLER","FILLER","FILLER","FILLER","FILLER","FILLER",
                  "FILLER","FILLER","FILLER",
                  "FILLER","FILLER","FILLER","FILLER","FILLER","FILLER",
                  "FILLER","FILLER","FILLER","FILLER","FILLER","FILLER","FILLER","FILLER",
                  "Cancer.Elected","Cancer.Descriptor","Cancer.Eff.Date",
                  "Benefit.Plan.Type","Coverage.Effective.Date","Benefit.Class.Name",
                  "Benefit.Class.SubCode1","Group.Suffix.4","Vision.Description",
                  "Dep.Life.Selected","Cobra.Enrollment.Date",
                  "STD.Elected","STD.Coverage.Amount","STD.Eff.Date") 
GuardianDf <- GuardianDf[, orderColumns]
```

Change Employment.Status..No.Codes. to format that Guardian wants; A=Active; T=Terminated= R=Retired.
```{r}
print("Coding employment status to Guardian specs.")
GuardianDf$Employment.Status..No.Codes.<- ifelse(GuardianDf$Employment.Status..No.Codes.=="ACTIVE","A",
                                                 ifelse(GuardianDf$Employment.Status..No.Codes.=="RETIRED","R","T"))
```

Marital status codes don't matter for Guardian; get rid of it. 
```{r}
print("Getting rid of NA values in Marital Status.")
dat<-GuardianDf$Marital.Status
for(i in dat)
    GuardianDf$Marital.Status<- NA
GuardianDf$Marital.Status<-ifelse(is.na(GuardianDf$Marital.Status)," "," ")
```

Get rid of unnecessary NA values in various columns.
```{r}
print("More NAs gettin' gone.")
GuardianDf$Work.Phone<-ifelse(is.na(GuardianDf$Work.Phone)," "," ")
```

So you can do quick sorting and identification of duplicates we must create an index. Below we concatenate several columns to accomplish this.
```{r}
print("Creating an index for the dataset.")
GuardianDf$Index<-paste(GuardianDf$Relationship..No.Codes.,GuardianDf$First.Name,GuardianDf$Last.Name,GuardianDf$Date.of.Birth,sep="_")
```

The code below is not active. Only use it if gender is messed up and reflects as "False" rather than Female. Activate the code by getting rid of the "#" before the code. 

Gender is printed so you can view it. If you see anything other than M or F, do the code that's blanked out.
```{r}
print("Only use this code if there are some weird false records in Gender; printed to help.")
GuardianDf$Gender
#GuardianDf$Gender<-ifelse(GuardianDf$Gender == "FALSE" & GuardianDf$Gender != "F", "F","M")
```

Guardian wants a reason for why if the Reason.For.Change is marked as Other. If Reason is Other (OT) populate FILLER 1 column.
```{r}
print("Print 'reasons' object then append to FILLER1 to end of table.")
reasons
GuardianDf$FILLERGUARDIAN<-ifelse(GuardianDf$Reason.for.Change=="OT",reasons," ")
```

There are many dates for Coverage Termination Date that have a year of 9999. The code below will replace 12/31/9999 in Coverage Termination Date with nothing.
```{r}
print("Removing 9999 from Coverage Termination Date.")
dat<-as.character(GuardianDf$Coverage.Termination.Date)
GuardianDf$Coverage.Termination.Date<-ifelse(grepl("9999",dat)," ",dat)
```

If you need to view the data frame before printing it, activate this code. You can edit within R. 
```{r}
# View(GuardianDf,"TEST")
```


Finally, write to CSV. The file will land in the same folder that 
```{r}
print("Writing file to CSV.")
write.csv(GuardianDf,file="output_Guardian.csv")
```

### File Post Processing
1. Copy and paste rows and columns, INCLUDING HEADERS, into the change report. 
2. Review it for accuracy; make manual changes where necessary.
3. Before deleting lines, make sure that each user's elections are combined into ONE row. 
4. Combine and delete redundant lines (eg. same person listed multiple times). 
5. Check for Cost changes and Address changes. Cost changes can be deleted; address changes can be deleted IF and ONLY IF there are other changes listed elsewhere for the same person. If not, keep.






