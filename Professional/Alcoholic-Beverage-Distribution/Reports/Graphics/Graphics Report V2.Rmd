---
title: "Major Brands Graphics Report"
author: "Paul Washburn, Operations Analyst"
date: "May 16, 2017"
output: 
  pdf_document:
      df_print: "kable" 
      fig_width: 10
      fig_height: 9
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

## Graphics data dump from Diver
library(rpivotTable)
library(dplyr)
library(reshape2)
library(lubridate)
library(treemap)
library(ggplot2)
library(googleVis)
library(plotly)
library(stringr)
source('C:/Users/pmwash/Desktop/R_files/Data Input/Helper.R')

this_yr = round(as.numeric(format(Sys.Date(), '%Y')),0)
last_yr = round(as.numeric(format(Sys.Date(), '%Y')) - 1,0)

## Read in and clean up the data
df = read.csv('C:/Users/pmwash/Desktop/Re-Engineered Reports/Graphics/graphics_data_dump_diver.csv', header=TRUE)
df$POSTERJob.ID = factor(df$POSTERJob.ID)
df = df %>% filter(Year %in% c(last_yr, this_yr))
df$Invoice.Date = dat = strptime(df$Invoice.Date, '%m/%d/%Y')
df$Week = week(dat)
df$Month = month(dat, TRUE, FALSE)
df$ProjectID_LineID = paste0(df$POSTERJob.ID, '_', df$POSTER.Item.ID)
df$POSTER.REPRINT = df$POSTER.REPRINT == 'Y'

## Set rownames
rownames(df) = c(1:NROW(df))

## Test df
#df = df[1:1000, ]

## Get string for job status - parse for turnaround
job_status = as.character(df$POSTER.JOB.STATUS)
df$POSTER.JOB.STATUS = NULL
names(job_status) = df$POSTERJob.ID
job_status = strsplit(job_status, ',')

for(i in 1:length(job_status)){
  try({
    start = regmatches(job_status[[i]][1][1], gregexpr("(?=\\().*?(?<=\\))", job_status[[i]][1][1], perl=T))
    assgn = regmatches(job_status[[i]][2][1], gregexpr("(?=\\().*?(?<=\\))", job_status[[i]][2][1], perl=T))
    brand = regmatches(job_status[[i]][3][1], gregexpr("(?=\\().*?(?<=\\))", job_status[[i]][3][1], perl=T))
    costs = regmatches(job_status[[i]][4][1], gregexpr("(?=\\().*?(?<=\\))", job_status[[i]][4][1], perl=T))
    artsy = regmatches(job_status[[i]][5][1], gregexpr("(?=\\().*?(?<=\\))", job_status[[i]][5][1], perl=T))
    appro = regmatches(job_status[[i]][6][1], gregexpr("(?=\\().*?(?<=\\))", job_status[[i]][6][1], perl=T))
    cmplt = regmatches(job_status[[i]][7][1], gregexpr("(?=\\().*?(?<=\\))", job_status[[i]][7][1], perl=T))
    shipp = regmatches(job_status[[i]][8][1], gregexpr("(?=\\().*?(?<=\\))", job_status[[i]][8][1], perl=T))
    
    start = gsub("[()]", "", start)
    assgn = gsub("[()]", "", assgn)
    brand = gsub("[()]", "", brand)
    costs = gsub("[()]", "", costs)
    artsy = gsub("[()]", "", artsy)
    appro = gsub("[()]", "", appro)
    cmplt = gsub("[()]", "", cmplt)
    shipp = gsub("[()]", "", shipp)
    
    start = gsub("\\s+", " ", start)
    assgn = gsub("\\s+", " ", assgn)
    brand = gsub("\\s+", " ", brand)
    costs = gsub("\\s+", " ", costs)
    artsy = gsub("\\s+", " ", artsy)
    appro = gsub("\\s+", " ", appro)
    cmplt = gsub("\\s+", " ", cmplt)
    shipp = gsub("\\s+", " ", shipp)
    
    df[i, 'Kickoff'] = start
    df[i, 'ArtistAssigned'] = assgn
    df[i, 'ObtainBrandMentions'] = brand
    df[i, 'CostApproved'] = costs
    df[i, 'ArtworkComplete'] = artsy
    df[i, 'RequesterApproved']= appro
    df[i, 'JobComplete'] = cmplt
    df[i, 'JobShipped'] = shipp
  })
}

## Format as date for maths
munge_date = function(dat) format(strptime(dat, '%b %d %Y %I:%M%p'), '%Y-%m-%d %H:%M')  
dat_cols = c('Kickoff','ArtistAssigned','ObtainBrandMentions','CostApproved',
             'ArtworkComplete','RequesterApproved','JobComplete','JobShipped')
df[, dat_cols] = sapply(df[, dat_cols], munge_date)

## Obtain time spent in each category
df$Turnaround_KickoffToShip = round(difftime(df$JobShipped, df$Kickoff, units="days"), 1)
df$Stage1_KickoffToAssignment = round(difftime(df$ArtistAssigned, df$Kickoff, units="days"), 1)
df$Stage2_AssignmentToBrandMentions = round(difftime(df$ObtainBrandMentions, df$ArtistAssigned, units="days"), 1)
df$Stage3_BrandMentionsToCostApproval = round(difftime(df$CostApproved, df$ObtainBrandMentions, units="days"), 1)
df$Stage4_CostApprovalToArtworkComplete = round(difftime(df$ArtworkComplete, df$CostApproved,units="days"), 1)
df$Stage5_ArtworkCompleteToRequesterApproval = round(difftime(df$RequesterApproved, df$ArtworkComplete, units="days"), 1)
df$Stage6_RequesterApprovalToCompletion = round(difftime(df$JobComplete, df$RequesterApproved, units="days"), 1)
df$Stage7_CompletionToShip = round(difftime(df$JobShipped, df$JobComplete, units="days"), 1)

## Obtain time from kickoff til each stage
df$KickoffToArtistAssigned = round(difftime(df$ArtistAssigned, df$Kickoff, units="days"), 1)
df$KickoffToBrandMentions = round(difftime(df$ObtainBrandMentions, df$Kickoff, units="days"), 1)
df$KickoffToCostApproval = round(difftime(df$CostApproved, df$Kickoff, units="days"), 1)
df$KickoffToArtworkComplete = round(difftime(df$ArtworkComplete, df$Kickoff, units="days"), 1)
df$KickoffToRequesterApproval = round(difftime(df$RequesterApproved, df$Kickoff, units="days"), 1)
df$KickoffToArtworkComplete = round(difftime(df$ArtworkComplete, df$Kickoff, units="days"), 1)
df$KickoffToArtworkComplete = round(difftime(df$ArtworkComplete, df$Kickoff, units="days"), 1)

# ## Write to CSV for Python
write.csv(df, 'C:/Users/pmwash/Desktop/Re-Engineered Reports/Graphics/intermediate_graphics_data_dump_diver.csv',
          row.names=FALSE)
```


# Measures of success for Graphics Team
This section was designed to help the Graphics department and management gain insight into the Graphics operation. In contrast, the next major section of this report is geared towards Graphics' impact on Sales and the organization at-large. 

## Turnaround by Designer
Figures below include weekends and holidays, and durations are measured in days. Active designers include Rachel, Brittany, and Katie; all others are filtered out of the dataset.

```{r descriptions}
guide_df = data.frame(row.names=c('Stage 1','Stage 2','Stage 3','Stage 4','Stage 5','Stage 6','Stage 7','Completion','Turnaround'),
                      Description=c('Job kickoff til artist assignment (days)',
                                    'Artist assignment til brand mentions obtained (days)',
                                    'Mentions obtained til cost approved (days)',
                                    'Cost approved til artwork complete (days)',
                                    'Artwork complete til requester approval (days)',
                                    'Requester approval til job completion (days)',
                                    'Job completion til ship (days)',
                                    'Job kickoff til job marked as complete (days)',
                                    'Job kickoff til job shipment (days)'))
guide_df
```


```{r turnaround}
library(tidyr)
library(reshape2)

active_designers = c('Mueller, Rachel','Riehlman, Brittany','Wilhoit, Katie')
df_thisyr = df[(df$Year == this_yr) & (df$POSTER.Designer %in% active_designers), ]

turn_cols = cbind(df_thisyr$Turnaround_KickoffToShip, 
                  df_thisyr$KickoffToArtworkComplete, 
                  df_thisyr$Stage1_KickoffToAssignment,
                  df_thisyr$Stage2_AssignmentToBrandMentions,
                  df_thisyr$Stage3_BrandMentionsToCostApproval,
                  df_thisyr$Stage4_CostApprovalToArtworkComplete,
                  df_thisyr$Stage5_ArtworkCompleteToRequesterApproval,
                  df_thisyr$Stage6_RequesterApprovalToCompletion,
                  df_thisyr$Stage7_CompletionToShip)
turnaround = aggregate(turn_cols ~ df_thisyr$POSTER.Designer, FUN=function(x) round(mean(x, na.rm=T), 1))
names(turnaround) = c('X','Turnaround','Completion','Stage 1','Stage 2',
                      'Stage 3','Stage 4','Stage 5','Stage 6','Stage 7')
rownames(turnaround) = turnaround$X
turnaround$X = NULL
turnaround
```

## Costs/Poster Price by Designer

```{r costs_bydesigner}
## melt and isolate data by designer
val_cols = c('POSTER.Price','POSTER.MB.mentions')
id_cols = c('POSTER.Designer','Month')

bydesigner_melt = melt(df_thisyr, id_cols, val_cols)

bydesigner = aggregate(value ~ variable + POSTER.Designer + Month, data=bydesigner_melt, FUN=sum)
bydesigner = spread(bydesigner, 'Month', 'value')

l_dfs = split(bydesigner, bydesigner$variable)
price_df = l_dfs$POSTER.Price

process_df = function(df) {
  rownames(df) = df$POSTER.Designer
  df$POSTER.Designer = df$variable = NULL
  return(df)
}
```

```{r bydesigner_plots, fig.height=7, fig.width=9}
library(scales)
byd_df = bydesigner
namz = names(byd_df)
namz = c(unlist(namz[namz %!in% c('variable','POSTER.Designer')]))
mentions_df_melt = melt(byd_df, c('variable','POSTER.Designer'), namz)
names(mentions_df_melt) = c('var','POSTER.Designer','Month','value')

ggplot(mentions_df_melt, aes(x=Month, y=value, group=POSTER.Designer)) +
  geom_line(aes(colour=POSTER.Designer)) +
  geom_point(alpha=0.6) +
  facet_wrap(~var, nrow=2, scales='free_y') +
  theme_minimal() +
  labs(title='Total Price and Mentions per Month by Designer', x='', y='') +
  scale_y_continuous(labels=comma)

process_df(price_df)
```

## Brand Mentions by Designer
Sum of all MB mentions by Designer for the current year.

```{r mentions_bydesigner}
mentions_df = l_dfs$POSTER.MB.mentions
process_df(mentions_df)
```


## Reprints by Designer
Total number of reprints for the current year, by Designer. Percent of Total is shown as a percent; in other words, it has been multiplied by 100 (e.g. 1.2 indicates 1.2%, or 0.012) .

```{r reprints}
reprint_cols = c('POSTERJob.ID','POSTER.Designer')
no_dupes = !duplicated(df[,reprint_cols])

reprints = df[no_dupes, c('POSTERJob.ID','POSTER.Designer','POSTER.REPRINT','Year')]
reprints = reprints[reprints$Year == this_yr, ]
reprints = aggregate(POSTER.REPRINT ~ POSTER.Designer, data=reprints, FUN=sum)

len_unique = function(x) length(unique(x))
tot_jobs = aggregate(POSTERJob.ID ~ POSTER.Designer, data=df_thisyr, FUN=len_unique)
reprints = merge(reprints, tot_jobs, by='POSTER.Designer', how='all')
reprints = process_df(reprints)

## Specify column names
names(reprints) = c('Number of Reprints', 'Total Jobs')
reprints$`Reprints as % of Total Jobs` = round((reprints$`Number of Reprints` / reprints$`Total Jobs`)*100, 1)
reprints
```

```{r reprint_plot, fig.height=5, fig.width=9}
reprints_t = data.frame(t(reprints))
names(reprints_t) = gsub('\\..', ', ', names(reprints_t))
reprints_t$Name = rownames(reprints_t)
rownames(reprints_t) = NULL
reprints_t_melt = melt(reprints_t, 'Name', active_designers)

ggplot(reprints_t_melt, aes(x=variable, y=value, group=Name)) +
  geom_bar(stat='identity', position='dodge', aes(fill=variable), colour='black') +
  facet_wrap(~Name, ncol=3, scales='free_y') +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(x='', y='')

```


## Number of Jobs per Month by Designer

```{r jobspermo_bydesigner}
jobspermo = aggregate(POSTERJob.ID ~ POSTER.Designer + Month, data=df_thisyr, FUN=len_unique)
jobspermo = spread(jobspermo, 'Month', 'POSTERJob.ID')
jobspermo = process_df(jobspermo)
jobspermo
```

```{r, fig.height=5, fig.width=9}
t_jobs = data.frame(t(jobspermo))
t_jobs$Month = row.names(t_jobs)
rownames(t_jobs) = NULL
t_jobs = melt(t_jobs, 'Month', c('Mueller..Rachel', 'Riehlman..Brittany', 'Wilhoit..Katie'))
t_jobs$variable = gsub('\\..', ', ', t_jobs$variable)
t_jobs$Month = factor(t_jobs$Month, c('January','February','March','April','May','June',
                                      'July','August','September','October','November','December'))

ggplot(data=t_jobs, aes(x=Month, y=value, group=variable)) +
  geom_line(aes(colour=variable)) +
  geom_point(alpha=.6, size=1.5) +
  labs(x='Month', y='Number of Jobs', title='Number of Jobs by Designer') +
  theme_minimal()
```


## Future Metrics
Currently two metrics that were requested are not available. 

  - On-Time completion of job: The field in PostR is unreliable as of now
  - Number of "rush" jobs: The "rush" field is not passed from PostR to Diver in the raw model

















<!-- ## Python to process -->
<!-- ```{python} -->
<!-- import pandas as pd -->

<!-- path = 'C:/Users/pmwash/Desktop/Re-Engineered Reports/Graphics/intermediate_graphics_data_dump_diver.csv' -->
<!-- df = pd.read_csv(path, header=0) -->
<!-- ## Use Python to process strings -->
<!-- df.head() -->
<!-- ``` -->






































